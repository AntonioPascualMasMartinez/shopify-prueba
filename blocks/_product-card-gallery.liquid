{% assign product = closest.product %}

{% assign badge_color = 'transparent' %}
{% assign badge_text = '' %}

{% if product.type != blank %}
  {% assign type_lower = product.type | downcase %}
  
  {% if type_lower contains 'iniciaci' %}
    {% assign badge_color = '#61d15c' %} {% assign badge_text = 'Iniciación' %}
  {% elsif type_lower contains 'medio' %}
    {% assign badge_color = '#eab308' %} {% assign badge_text = 'Iniciados' %}
  {% elsif type_lower contains 'experto' or type_lower contains 'avanzado' %}
    {% assign badge_color = '#f97316' %} {% assign badge_text = 'Experimentados' %}
  {% else %}
    {% assign badge_color = '#283583' %} {% assign badge_text = product.type %}
  {% endif %}
{% endif %}

<div class="custom-card-header">
  {% if badge_text != '' %}
    <div class="custom-badge-top-left">
      <span class="custom-badge-dot" style="background-color: {{ badge_color }};"></span>
      <span class="custom-badge-text">{{ badge_text }}</span>
    </div>
  {% else %}
    <div></div> {% endif %}

  <button class="custom-wishlist-top-right" aria-label="Añadir a favoritos">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
    </svg>
  </button>
</div>

{% capture children %}
  {% unless product == blank %}
    
    <div class="custom-hover-buy-container">
      {%- form 'product', product, class: 'custom-buy-form' -%}
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
        <button type="submit" class="custom-hover-buy-btn" {% if product.available == false %}disabled{% endif %}>
          {% if product.available %}
            Comprar
          {% else %}
            Agotado
          {% endif %}
        </button>
      {%- endform -%}
    </div>

    <div
      class="product-badges product-badges--{{ settings.badge_position }}"
      style="
        --badge-border-radius: {{ settings.badge_corner_radius }}px;
        --badge-font-family: var(--font-{{ settings.badge_font_family }}--family); --badge-font-weight: var(--font-{{ settings.badge_font_family }}--weight); --badge-text-transform: {{ settings.badge_text_transform }};
      "
    >
      {%- if product.available == false or product.compare_at_price > product.price -%}
        <div
          class="
            product-badges__badge product-badges__badge--rectangle
            {% if product.available == false %} color-{{ settings.badge_sold_out_color_scheme }}{% elsif product.compare_at_price > product.price %} color-{{ settings.badge_sale_color_scheme }}{% endif %}
          "
        >
          {%- if product.available == false -%}
            {{ 'content.product_badge_sold_out' | t }}
          {%- elsif product.compare_at_price > product.price -%}
            {{ 'content.product_badge_sale' | t }}
          {%- endif -%}
        </div>
      {%- endif -%}
    </div>

  {% endunless %}
{% endcapture %}

{% render 'card-gallery', children: children %}

{% # Title and price for the zoomed out grid view %}
<div class="product-grid-view-zoom-out--details">
  {% if product == blank %}
    <h3 class="h4">{{ 'content.product_card_placeholder' | t }}</h3>
  {% else %}
    <h3 class="h4">{{ product.title }}</h3>
  {% endif %}
</div>

{% stylesheet %}
  /* --- CABECERA DE LA TARJETA (Fondo blanco) --- */
  .custom-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #ffffff;
    padding: 12px;
    width: 100%;
  }

  /* Etiqueta ahora integrada en el flujo (sin position: absolute) */
  .custom-badge-top-left {
    border: 1px solid #283583;
    border-radius: 20px;
    padding: 4px 12px 4px 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #283583;
    font-weight: 500;
  }

  .custom-badge-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }

  /* Corazón ahora integrado en el flujo (sin position: absolute) */
  .custom-wishlist-top-right {
    background: transparent;
    border: none;
    color: #7b85a3;
    cursor: pointer;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .custom-wishlist-top-right:hover {
    transform: scale(1.1);
    color: #283583;
  }

  .custom-wishlist-top-right svg {
    width: 24px;
    height: 24px;
  }

  /* --- BOTÓN COMPRAR EN HOVER --- */
  .custom-hover-buy-container {
    position: absolute;
    bottom: 15px;
    left: 0;
    width: 100%;
    padding: 0 15px;
    z-index: 3;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    pointer-events: none;
  }

  product-card:hover .custom-hover-buy-container,
  .card:hover .custom-hover-buy-container,
  .product-item:hover .custom-hover-buy-container,
  .card-gallery:hover .custom-hover-buy-container {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .custom-buy-form {
    margin: 0;
    width: 100%;
  }

  .custom-hover-buy-btn {
    width: 100%;
    background-color: #283583;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 12px 0;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: background-color 0.2s ease;
  }

  .custom-hover-buy-btn:hover {
    background-color: #1e295d;
  }

  /* --- TRANSICIÓN SUAVE DE IMAGEN (SMOOTH HOVER) --- */
  .card-gallery img,
  .card-gallery .media > *,
  .product-item img {
    transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out !important;
  }

  /* --- ESTILOS ORIGINALES NATIVOS --- */
  .product-badges {
    --badge-inset: max(var(--padding-xs), calc((var(--border-radius) + var(--padding-xs)) * (1 - cos(45deg))));
    position: absolute;
    z-index: var(--layer-flat);
  }

  .product-badges--bottom-left {
    bottom: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-left {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-right {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges__badge {
    --badge-font-size: var(--font-size--xs);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--color-foreground);
    background: var(--color-background);
    font-size: var(--badge-font-size);
    font-family: var(--badge-font-family);
    font-weight: var(--badge-font-weight);
    text-transform: var(--badge-text-transform);
    border-radius: var(--badge-border-radius);
  }

  .product-badges__badge--rectangle {
    padding-block: var(--badge-rectangle-padding-block);
    padding-inline: var(--badge-rectangle-padding-inline);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.product_image",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "t:content.resource_reference_product_media"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:options.auto"
        },
        {
          "value": "portrait",
          "label": "t:options.portrait"
        },
        {
          "value": "square",
          "label": "t:options.square"
        },
        {
          "value": "landscape",
          "label": "t:options.landscape"
        }
      ],
      "default": "portrait",
      "label": "t:settings.aspect_ratio",
      "info": "t:info.aspect_ratio_adjusted"
    },
    {
      "type": "header",
      "content": "t:content.borders"
    },
    {
      "type": "select",
      "id": "border",
      "label": "t:settings.style",
      "options": [
        {
          "value": "none",
          "label": "t:options.none"
        },
        {
          "value": "solid",
          "label": "t:options.solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "t:settings.thickness",
      "default": 1,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "t:settings.opacity",
      "default": 100,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "t:settings.border_radius",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.product_card_media",
      "category": "t:categories.product"
    }
  ]
}
{% endschema %}